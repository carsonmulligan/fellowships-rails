<!-- Add this hidden form at the top of the modal -->
<%= form_tag user_google_oauth2_omniauth_authorize_path, method: :post, data: { turbo: false }, id: 'google-auth-form' do %>
  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
<% end %>

<!-- Premium Features Modal -->
<div id="premium-features-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    
    <div class="modal-grid">
      <!-- Left Panel - Scrollable Content -->
      <div class="modal-left">
        <h2>What Our Users Say</h2>
        
        <div class="testimonial">
          <p>"This platform helped me find and win the Yenching Scholarship!"</p>
          <cite>- Sarah K., Harvard '23</cite>
        </div>
        
        <div class="testimonial">
          <p>"The tracking features made managing multiple applications so much easier."</p>
          <cite>- James L., Oxford '22</cite>
        </div>

        <div class="stats">
          <div class="stat-item">
            <h3>1000+</h3>
            <p>Active Scholarships</p>
          </div>
          <div class="stat-item">
            <h3>50+</h3>
            <p>Countries</p>
          </div>
          <div class="stat-item">
            <h3>10,000+</h3>
            <p>Happy Students</p>
          </div>
        </div>

        <div class="features-list">
          <div class="feature">
            <h3>üîç Smart Search</h3>
            <p>Find scholarships matching your profile and interests</p>
          </div>
          <div class="feature">
            <h3>‚≠êÔ∏è Bookmarking</h3>
            <p>Save and organize your favorite opportunities</p>
          </div>
          <div class="feature">
            <h3>üîî Notifications</h3>
            <p>Never miss deadlines with smart alerts</p>
          </div>
        </div>
      </div>

      <!-- Right Panel - Fixed Content -->
      <div class="modal-right">
        <div class="video-container">
          <iframe 
            width="100%" 
            height="315" 
            src="https://www.youtube.com/embed/UVtrvArSihQ?si=_5mGUBGwWCZNVL1M" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
          </iframe>
        </div>

        <div class="premium-features">
          <h2>üîí Premium Features</h2>
          <ul>
            <li>‚≠êÔ∏è Bookmark Scholarships</li>
            <li>üìù Track Applications</li>
            <li>üîî Get Notifications</li>
            <li>üí¨ Join Community Chat</li>
          </ul>
          
          <button onclick="handlePurchase()" class="buy-button">
            üöÄ Get Premium Access
          </button>
        </div>

        <div class="pricing">
          <div class="price-tag">
            <span class="original-price">$99</span>
            <span class="current-price">$79</span>
            <span class="lifetime">Lifetime Access</span>
          </div>
          <div class="limited-offer">
            üî• Limited Time Offer - Save $20
          </div>
          <div class="price-guarantee">30-day money-back guarantee</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
  }

  .modal-content {
    position: relative;
    background: white;
    margin: 2% auto;
    max-width: 1000px;
    width: 90%;
    border-radius: 12px;
    overflow: hidden;
  }

  .close-btn {
    position: absolute;
    right: 30px;
    top: 25px;
    font-size: 24px;
    cursor: pointer;
    z-index: 10;
    color: #666;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 600px;
  }

  .modal-left {
    padding: 2rem;
    overflow-y: auto;
    max-height: 80vh;
    border-right: 1px solid #eee;
  }

  .modal-right {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .video-container {
    width: 100%;
    margin-bottom: 1rem;
  }

  .testimonial {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .testimonial p {
    font-style: italic;
    margin-bottom: 0.5rem;
  }

  .testimonial cite {
    color: #666;
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin: 2rem 0;
    text-align: center;
  }

  .stat-item h3 {
    font-size: 1.8rem;
    color: #007bff;
    margin-bottom: 0.5rem;
  }

  .features-list {
    margin-top: 2rem;
  }

  .feature {
    margin-bottom: 1.5rem;
  }

  .feature h3 {
    margin-bottom: 0.5rem;
    color: #333;
  }

  .premium-features {
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .premium-features ul {
    list-style: none;
    padding: 0;
    margin-bottom: 1.5rem;
    text-align: left;
  }

  .premium-features li {
    margin-bottom: 0.8rem;
    font-size: 1.1rem;
  }

  .pricing {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .price-tag {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .original-price {
    font-size: 1.5rem;
    color: #999;
    text-decoration: line-through;
  }

  .current-price {
    font-size: 2.5rem;
    font-weight: bold;
    color: #28a745;
  }

  .lifetime {
    font-size: 1rem;
    color: #666;
  }

  .limited-offer {
    color: #dc3545;
    font-weight: bold;
    margin-bottom: 1rem;
  }

  .cta-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .google-sign-in {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 0.8rem;
    border: 1px solid #ddd;
    border-radius: 25px;
    background: white;
    cursor: pointer;
    width: 100%;
    font-size: 1.1rem;
    transition: background-color 0.2s;
  }

  .google-sign-in:hover {
    background: #f8f9fa;
  }

  .google-sign-in img {
    width: 20px;
    height: 20px;
  }

  .price-note {
    text-align: center;
    color: #666;
    font-size: 0.9rem;
  }

  .buy-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin: 1rem 0;
  }

  .buy-button:hover {
    background: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .price-guarantee {
    text-align: center;
    color: #666;
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('premium-features-modal');
    const closeBtn = document.querySelector('.close-btn');

    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  });

  async function handlePurchase() {
    // First, trigger Google Sign In if not signed in
    if (!<%= !!session[:user_id] %>) {
      // Store intent to purchase
      localStorage.setItem('initiate_purchase', 'true');
      // Trigger Google Sign In
      document.getElementById('google-auth-form').submit();
      return;
    }

    // If already signed in or after sign in, proceed with Stripe checkout
    try {
      const response = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      });
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }

      // Redirect to Stripe Checkout
      window.location.href = data.url;
    } catch (error) {
      console.error('Error:', error);
      alert('Something went wrong. Please try again.');
    }
  }

  // Check if we need to initiate purchase after sign in
  if (<%= !!session[:user_id] %> && localStorage.getItem('initiate_purchase')) {
    localStorage.removeItem('initiate_purchase');
    handlePurchase();
  }
</script>

<!-- Add Stripe.js -->
<script src="https://js.stripe.com/v3/"></script> 